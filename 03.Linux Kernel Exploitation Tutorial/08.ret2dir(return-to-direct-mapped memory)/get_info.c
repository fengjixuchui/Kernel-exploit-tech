#include <err.h>
#include <errno.h>
#include <fcntl.h>
#include <getopt.h>
#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/mman.h>

/* constants */
#define PATH_SZ		32        /* path size (/proc/<pid>/pagemap) */
#define PRESENT_MASK	(1ULL << 63)     /* get bit 63 from a 64-bit integer */
#define PFN_MASK	((1ULL << 55) - 1)    /* get bits 0-54 from */

#define ALLOC_STEP    1024*1024*512    /* chunk of 512MB */

void querypmap(pid_t pid, unsigned long vaddr, long psize, size_t pnum)
{
	    char             path[PATH_SZ];         /* path in /proc     */
	        uint64_t         *pentry    = NULL;     /* pagemap entries    */
		    FILE             *fp    = NULL;         /* pagemap file        */
		        
		        /* 페이지맵 항목 초기화 */
		        if ((pentry = calloc(pnum, sizeof(uint64_t))) == NULL)
				        errx(7,"[Fail] couldn't allocate memory for pagemap entries -- %s",strerror(errno));
			        
			    memset(path, 0, PATH_SZ);
			            
			        if (snprintf(path, PATH_SZ, "/proc/%d/pagemap", pid) >= PATH_SZ)        /* format the path variable */
					        errx(4,"[Fail] invalid path for /proc/%d/pagemap -- %s",pid,path);
				        
				    if ((fp = fopen(path, "r")) == NULL)                                    /* open the pagemap file */
					            errx(4,"[Fail] couldn't open %s -- %s",path,strerror(errno));
				            
				        if (fseek(fp, (vaddr / psize) * sizeof(uint64_t), SEEK_CUR) == -1)      /* seek to the appropriate place */
						        errx(5,"[Fail] couldn't seek in pagemap -- %s",strerror(errno));    
					        
					    if (fread(pentry, sizeof(uint64_t), pnum, fp) != pnum)                  /* read the corresponding pagemap entries */
						            errx(6,"[Fail] couldn't read pagemap entries -- %s",strerror(errno));
					                            
					        while (pnum > 0) {
							        /* check the present bit */
							        if ((pentry[pnum - 1] & PRESENT_MASK) == 0) {
									            printf("[*] present bit 0\n");

										                /* proper accounting */
										                pnum--;
												            
												            /* continue with the next page */
												            continue;
													            }

								        /* verbose */
								        printf("[*] Page Number %zd\n", pnum - 1);
									        printf("[*] present bit 1\n");
										        printf("[*] PFN is %llu\n\n", pentry[pnum - 1] & PFN_MASK);

											        /* proper accounting */
											        pnum--;
												    }
						                            
						    /* cleanup */
						    fclose(fp);
						        return;
}
    
void main()
{
	    long psize;                			/* page size        */
	        char     *code        = NULL;    		/* shellcode buffer */
		    
		    /* get the page size */
		    if ((psize = sysconf(_SC_PAGESIZE)) == -1)
			        /* failed */
			            errx(2,
						                 "[Fail] couldn't read page size -- %s",
								              strerror(errno));
		        
		        /* allocate ALLOC_STEP bytes in user space */
		        if ((code = mmap(NULL,
							                     ALLOC_STEP,
									                          PROT_READ | PROT_WRITE,
												                       MAP_PRIVATE | MAP_ANONYMOUS | MAP_POPULATE,
														                            -1,
																	                         0)) == MAP_FAILED)
				    /* failed */
				        errx(7,
							             "[Fail] couldn't allocate memory -- %s", strerror(errno));

			    /* see if user space is kernel-mapped */
			    querypmap(getpid(),
					                        (unsigned long)code,
								                    psize,
										                        ALLOC_STEP / psize);
			        
}
